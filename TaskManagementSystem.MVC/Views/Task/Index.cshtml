@model IEnumerable<TaskManagementSystem.MVC.Models.TaskViewModel>
@{
    ViewData["Title"] = "قائمة المهام";
    var role = Context.Session.GetString("UserRole");
    //var role = "Admin"; // "Manager" أو "User" حسب ما تريد تجربته
}
@*<h2>قائمة المهام</h2>
<a asp-action="Create" class="btn btn-success mb-3">+ مهمة جديدة</a>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>العنوان</th>
            <th>الوصف</th>
            <th>الأولوية</th>
            <th>النظام</th>
            <th>الحالة</th>
            <th>الموظف المسؤول</th>
            <th>إجراءات</th>
        </tr>
    </thead>
    <tbody>
    @foreach(var task in Model)
    {
        <tr>
            <td>@task.Title</td>
            <td>@task.Description</td>
            <td>@task.Priority</td>
            <td>@task.System</td>
            <td>@task.Status</td>
            <td>@task.AssignedToName</td>
            <td>
                <a asp-action="Edit" asp-route-id="@task.Id" class="btn btn-sm btn-primary">تعديل</a>
                @if(role == "Manager" || role == "Admin")
                {
                    <form asp-action="Delete" asp-route-id="@task.Id" method="post" style="display:inline-block">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('هل متأكد من الحذف؟');">حذف</button>
                    </form>
                }
            </td>
        </tr>
    }
    </tbody>
</table>
*@
@*

@model IEnumerable<TaskManagementSystem.MVC.Models.TaskViewModel>
@{
    ViewData["Title"] = "قائمة المهام";
  //  var role = Context.Session.GetString("UserRole");
}
*@
 @*<div class="mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">لوحة التحكم الرئيسية</h3>
                <div class="bg-white rounded-lg shadow-lg p-8 border">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xl font-semibold">مرحباً، أحمد محمد</h4>
                        <div class="flex space-x-4 space-x-reverse">



                            <button asp-action="Create" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                                <i class="fas fa-plus ml-2"></i>
                                مهمة جديدة
                            </button>
                             <a asp-action="Create" class="btn-primary bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">+ مهمة جديدة</a>
                            <div class="relative">
                                <i class="fas fa-bell text-xl text-gray-600 relative">
                                    <span
                                        class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                                </i>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold text-blue-800">@Model.NewTasks</div>
                                    <div class="text-blue-600">مهام جديدة</div>
                                </div>
                                <i class="fas fa-plus-circle text-2xl text-blue-600"></i>
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold text-yellow-800">@Model.InProgressTasks</div>
                                    <div class="text-yellow-600">قيد التنفيذ</div>
                                </div>
                                <i class="fas fa-sync-alt text-2xl text-yellow-600"></i>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold text-green-800">@Model.CompletedTasks</div>
                                    <div class="text-green-600">مكتملة</div>
                                </div>
                                <i class="fas fa-check-circle text-2xl text-green-600"></i>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold text-red-800">@Model.OverdueTasks</div>
                                    <div class="text-red-600">متأخرة</div>
                                </div>
                                <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <h5 class="text-lg font-semibold mb-4">المهام الأخيرة</h5>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-red-500 rounded-full ml-3"></div>
                                    <div>
                                        <div class="font-semibold">تطوير واجهة تسجيل الدخول</div>
                                        <div class="text-sm text-gray-600">تم التعيين إلى: سارة أحمد</div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">منذ ساعتين</div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full ml-3"></div>
                                    <div>
                                        <div class="font-semibold">إصلاح مشكلة في قاعدة البيانات</div>
                                        <div class="text-sm text-gray-600">تم التعيين إلى: محمد علي</div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">أمس</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
*@
            
<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">قائمة المهام</h2>
        <a asp-action="Create" class="btn-primary">+ مهمة جديدة</a>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-right">العنوان</th>
                    <th class="px-4 py-2 text-right">الأولوية</th>
                    <th class="px-4 py-2 text-right">النظام</th>
                    <th class="px-4 py-2 text-right">الحالة</th>
                    <th class="px-4 py-2 text-right">الموظف المسؤول</th>
                    <th class="px-4 py-2 text-right">إجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Model)
                {
                    <tr class="border-b">
                        <td class="px-4 py-2 text-right">@task.Title</td>
                        <td class="px-4 py-2 text-right">@task.Priority</td>
                        <td class="px-4 py-2 text-right">@task.System</td>
                        <td class="px-4 py-2 text-right">
                            @if (task.Status == "Overdue")
                            {
                                <span class="text-red-600 font-semibold">@task.Status</span>
                            }
                            else if (task.Status == "Completed")
                            {
                                <span class="text-green-600 font-semibold">@task.Status</span>
                            }
                            else
                            {
                                <span class="text-gray-700">@task.Status</span>
                            }
                        </td>
                        <td class="px-4 py-2 text-right">@task.AssignedToName</td>
                        <td class="px-4 py-2 text-right space-x-2">
                            <a asp-action="Edit" asp-route-id="@task.Id" class="text-blue-500 hover:underline">تعديل</a>
                            @if (role == "Manager" || role == "Admin")
                            {
                               <form asp-action="Delete" asp-route-id="@task.Id" method="post" class="inline-block" onsubmit="return confirmDelete(this, '@task.Title');">
    @Html.AntiForgeryToken()
    <button type="submit" class="text-red-600 hover:text-red-800 mx-2">حذف</button>
</form>
                            }
                        </td>
                        @*<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
    <a asp-action="Edit" asp-route-id="@task.Id" class="text-blue-600 hover:text-blue-800 mx-2">تعديل</a>
    @if (role == "Manager" || role == "Admin")
    {
        <a href="#" class="text-red-600 hover:text-red-800 mx-2"
           onclick="confirmDelete(@task.Id, '@task.Title')">حذف</a>
    }
</td>
*@
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@*<form method="post">
    @Html.AntiForgeryToken()
</form>*@

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function confirmDelete(form, taskTitle) {
        event.preventDefault(); // نمنع الإرسال
        Swal.fire({
            title: 'هل أنت متأكد؟',
            text: `سيتم حذف المهمة (${taskTitle}) نهائيًا!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم، احذف',
            cancelButtonText: 'إلغاء'
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit(); // إرسال النموذج بعد التأكيد
            }
        });

        return false;
    }
    //function confirmDelete(taskId, taskTitle) {
    //    Swal.fire({
    //        title: 'هل أنت متأكد؟',
    //        text: `سيتم حذف المهمة (${taskTitle}) نهائيًا!`,
    //        icon: 'warning',
    //        showCancelButton: true,
    //        confirmButtonText: 'نعم، احذف',
    //        cancelButtonText: 'إلغاء'
    //    }).then((result) => {
    //        if (result.isConfirmed) {
    //            fetch(`/Task/DeleteConfirmed/${taskId}`, {
    //                method: 'POST',
    //                headers: {
    //                    'RequestVerificationToken': getAntiForgeryToken()
    //                }
    //            })
    //            .then(res => {
    //                if (res.ok) {
    //                    Swal.fire('تم الحذف!', 'تم حذف المهمة بنجاح.', 'success')
    //                        .then(() => location.reload());
    //                } else {
    //                    Swal.fire('خطأ!', 'فشل حذف المهمة.', 'error');
    //                }
    //            });
    //        }
    //    });
    //}

    function getAntiForgeryToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }
</script>
